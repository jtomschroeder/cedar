<!doctype html>
<html lang="en">
<head>
    <title>Title?</title>
    <style>
        /* {{ styles }} */
    </style>
</head>
<body>
<script type="text/javascript">
    "use strict";

    function setup() {
        console.log("Setting up cedar!");

        const invokeRaw = msg => window.external.invoke(msg);
        const invoke = msg => invokeRaw(JSON.stringify(msg));

        const cedar = window.cedar = {
            nodes: {"": document.body},

            click: id => () => invoke({Click: {id}}),

            input: (id, element) => () => {
                const value = element.value || '';
                invoke({Input: {id, value}});
            },

            keydown: id => e => invoke({Keydown: {id, code: e.keyCode || e.which}}),

            attributes: (node, attributes) => {
                for (let [key, value] of Object.entries(attributes)) {
                    let value = attributes[key];

                    // HACK: convert to Boolean
                    if (value === "true") {
                        value = true;
                    } else if (value === "false") {
                        value = false;
                    } else {
                        // value is untouched
                    }

                    node[key] = value;
                }
            },

            command: (cmd) => {
                const command = JSON.parse(cmd);

                if (command.hasOwnProperty('Create')) {
                    const create = command.Create;

                    const id = create.id;
                    const kind = create.kind;
                    const value = create.value;

                    const attributes = create.attributes;

                    let node =
                        kind === 'text'
                            ? document.createTextNode(value)
                            : document.createElement(kind);

                    // TODO: only register for nodes that need to?
                    // TODO: handle 'duplicate' events?

                    node.addEventListener("click", cedar.click(id));

                    node.addEventListener("input", cedar.input(id, node));
                    node.addEventListener("keydown", cedar.keydown(id));

                    // var input = cedar.input(id, node);
                    // node.addEventListener("keypress", input);
                    // node.addEventListener("input", input);
                    // node.addEventListener("paste", input);

                    cedar.attributes(node, attributes);

                    let parent = cedar.nodes[create.parent];
                    parent.appendChild(node);

                    cedar.nodes[id] = node;
                } else if (command.hasOwnProperty('Update')) {
                    const update = command.Update;

                    const id = update.id;
                    const value = update.value;

                    let node = cedar.nodes[id];

                    if (value.hasOwnProperty('Text')) {
                        node.nodeValue = value.Text;
                    } else if (value.hasOwnProperty('Attributes')) {
                        cedar.attributes(node, value.Attributes);
                    } else {
                        // console.log("Unsupported value!");
                    }
                } else if (command.hasOwnProperty('Remove')) {
                    const id = command.Remove.id;
                    cedar.nodes[id].remove();
                }
            },
        };

        invokeRaw("$"); // trigger setup!
    }

    window.onload = () => setup();
</script>
</body>
</html>
